{% extends "base.html" %}

{% block title %}Content Management - AIMS{% endblock %}

{% block content %}
<div x-data="contentManager()" x-init="init()" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Learning Content Management</h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Manage learning content for courses, lessons, and learning outcomes</p>
    </div>

    <!-- Controls -->
    <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-between">
        <input type="text" 
               x-model="searchTerm" 
               @input="filterContent()"
               class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
               placeholder="Search courses, lessons, or learning outcomes...">
        <div class="flex gap-2">
            <button @click="openCourseModal()" 
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                + New Course
            </button>
            <button @click="expandAll()" 
                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                Expand All
            </button>
            <button @click="collapseAll()" 
                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                Collapse All
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex flex-col items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400"></div>
        <p class="mt-4 text-gray-600 dark:text-gray-400">Loading content...</p>
    </div>

    <!-- Courses List -->
    <div x-show="!loading" class="space-y-4">
        <template x-for="(course, courseIdx) in filteredCourses" :key="course.id">
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800 shadow-sm">
                <!-- Course Header -->
                <div class="w-full px-6 py-4 flex items-center justify-between bg-white dark:bg-gray-800">
                    <div class="flex items-center gap-3 cursor-pointer" @click="toggleCourse(courseIdx)">
                        <svg class="w-5 h-5 transition-transform text-gray-700 dark:text-gray-300" 
                             :class="{'rotate-90': course.expanded}"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        <span class="font-semibold text-gray-900 dark:text-gray-100" x-text="course.title"></span>
                        <span class="px-2 py-1 text-xs font-medium bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded-full" 
                              x-text="`${course.lessons.length} lessons`"></span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="generateAllCourseContent(course)" 
                                class="px-3 py-1 text-sm bg-amber-600 text-white rounded hover:bg-amber-700 transition"
                                title="Generate AI content for all learning outcomes">
                            ⚡ Generate All Content
                        </button>
                        <button @click="openLessonModal(course)" 
                                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                            + Lesson
                        </button>
                        <button @click="openLessonAIModal(course)" 
                                class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition" 
                                title="AI-Suggest Lesson Structure">
                            ✨ AI Suggest
                        </button>
                        <button @click="openEditCourseModal(course)" 
                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                            Edit
                        </button>
                        <button @click="deleteCourse(course.id)" 
                                class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                            Delete
                        </button>
                    </div>
                </div>
                
                <!-- Lessons -->
                <div x-show="course.expanded" 
                     class="border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <div class="p-4 space-y-3">
                        <template x-for="(lesson, lessonIdx) in course.lessons" :key="lesson.id">
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800">
                                <!-- Lesson Header -->
                                <div class="w-full px-4 py-3 flex items-center justify-between bg-white dark:bg-gray-800">
                                    <div class="flex items-center gap-2 cursor-pointer" @click="toggleLesson(courseIdx, lessonIdx)">
                                        <svg class="w-4 h-4 transition-transform text-gray-700 dark:text-gray-300" 
                                             :class="{'rotate-90': lesson.expanded}"
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                        <span class="font-medium text-gray-800 dark:text-gray-200" x-text="lesson.title"></span>
                                        <span class="px-2 py-0.5 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full" 
                                              x-text="`${lesson.learning_outcomes.length} outcomes`"></span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="openOutcomeModal(lesson)" 
                                                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                            + Outcome
                                        </button>
                                        <button @click="openEditLessonModal(lesson)" 
                                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                            Edit
                                        </button>
                                        <button @click="deleteLesson(lesson.id)" 
                                                class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Learning Outcomes -->
                                <div x-show="lesson.expanded" 
                                     class="border-t border-gray-200 dark:border-gray-700">
                                    <div class="p-4 space-y-2">
                                        <template x-for="outcome in lesson.learning_outcomes" :key="outcome.id">
                                            <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 hover:border-gray-300 dark:hover:border-gray-600 transition">
                                                <div class="flex items-start justify-between mb-3">
                                                    <div class="flex-1">
                                                        <h6 class="font-medium text-gray-900 dark:text-gray-100" x-text="outcome.key"></h6>
                                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1" x-text="outcome.description"></p>
                                                    </div>
                                                    <div class="flex gap-2 ml-4">
                                                        <button @click="openUploadModal(outcome)" 
                                                                class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                                                            Upload
                                                        </button>
                                                        <button @click="openGenerateModal(outcome)"
                                                                x-show="outcome.content_chunks.length === 0" 
                                                                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                                            Generate
                                                        </button>
                                                        <button @click="openEditOutcomeModal(outcome)" 
                                                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                                            Edit
                                                        </button>
                                                        <button @click="deleteOutcome(outcome.id)" 
                                                                class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Content Chunks -->
                                                <div x-show="outcome.content_chunks.length > 0" class="mt-3 space-y-2">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Content Chunks</p>
                                                        <button @click="openAddChunkModal(outcome)" 
                                                                class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition">
                                                            + Add Chunk
                                                        </button>
                                                    </div>
                                                    <template x-for="(chunk, chunkIdx) in outcome.content_chunks" :key="chunk.id">
                                                        <div class="flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                                                            <!-- Reorder buttons -->
                                                            <div class="flex flex-col gap-1">
                                                                <button @click="moveChunkUp(outcome.id, chunkIdx)" 
                                                                        x-show="chunkIdx > 0"
                                                                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/>
                                                                    </svg>
                                                                </button>
                                                                <button @click="moveChunkDown(outcome.id, chunkIdx)" 
                                                                        x-show="chunkIdx < outcome.content_chunks.length - 1"
                                                                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                                                <span class="px-2 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded" 
                                                                      x-text="chunk.content_type"></span>
                                                                <span class="px-2 py-1 text-xs font-medium rounded" 
                                                                      :class="{
                                                                          'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200': chunk.approval_status === 'approved',
                                                                          'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200': chunk.approval_status === 'pending',
                                                                          'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200': chunk.approval_status === 'rejected'
                                                                      }"
                                                                      x-text="chunk.approval_status"></span>
                                                                <span class="text-sm text-gray-600 dark:text-gray-400 truncate" 
                                                                      x-text="chunk.content_text.substring(0, 80) + '...'"></span>
                                                            </div>
                                                            <div class="flex gap-2">
                                                                <button @click="openEditModal(chunk, outcome.id)" 
                                                                        class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                                                    Edit
                                                                </button>
                                                                <button @click="deleteContentChunk(chunk.id)" 
                                                                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                                <!-- Add chunk button when no chunks exist -->
                                                <div x-show="outcome.content_chunks.length === 0" class="mt-3">
                                                    <button @click="openAddChunkModal(outcome)" 
                                                            class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                                        + Add Content Chunk
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Upload Modal -->
    <div x-show="modals.upload" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70" 
         @click.self="modals.upload = false">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Add Learning Content</h3>
            </div>
            <div class="p-6 space-y-4">
                <!-- Upload Method Toggle -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Upload Method</label>
                    <div class="flex gap-2">
                        <button @click="uploadMethod = 'text'" 
                                :class="uploadMethod === 'text' ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600'"
                                class="flex-1 px-4 py-2 rounded-lg font-medium transition">
                            Text Input
                        </button>
                        <button @click="uploadMethod = 'pdf'" 
                                :class="uploadMethod === 'pdf' ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600'"
                                class="flex-1 px-4 py-2 rounded-lg font-medium transition">
                            PDF Upload
                        </button>
                    </div>
                </div>

                <!-- Text Input -->
                <div x-show="uploadMethod === 'text'" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content Type</label>
                        <select x-model="uploadData.contentType" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="definition">Definition</option>
                            <option value="explanation">Explanation</option>
                            <option value="example">Example</option>
                            <option value="procedure">Procedure</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content</label>
                        <textarea x-model="uploadData.contentText" 
                                  rows="10" 
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                  placeholder="Enter content..."></textarea>
                    </div>
                </div>

                <!-- PDF Upload -->
                <div x-show="uploadMethod === 'pdf'">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select PDF File</label>
                    <input type="file" @change="handlePdfSelect" accept=".pdf"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button @click="modals.upload = false" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    Cancel
                </button>
                <button @click="submitUpload()" 
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Generate Modal -->
    <div x-show="modals.generate" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70" 
         @click.self="modals.generate = false">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Generate AI Content</h3>
            </div>
            <div class="p-6">
                <div x-show="!generatedContent">
                    <p class="text-gray-700 dark:text-gray-300">Generate AI-powered learning content for:</p>
                    <p class="mt-2 font-semibold text-gray-900 dark:text-gray-100" x-text="selectedOutcome?.description"></p>
                </div>
                <div x-show="generatedContent">
                    <textarea x-model="generatedContent" rows="15" 
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 dark:border-gray-700 flex justify-end gap-3">
                <button @click="modals.generate = false" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    Cancel
                </button>
                <button @click="generateContent()" x-show="!generatedContent"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Generate
                </button>
                <button @click="saveGenerated()" x-show="generatedContent"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div x-show="modals.edit" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70" 
         @click.self="modals.edit = false">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Edit Content</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content</label>
                    <textarea x-model="editData.contentText" rows="10"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Approval Status</label>
                    <select x-model="editData.approvalStatus"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-between">
                <button @click="deleteContent()" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                    Delete
                </button>
                <div class="flex gap-3">
                    <button @click="modals.edit = false" 
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        Cancel
                    </button>
                    <button @click="saveEdit()" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Content Chunk Modal -->
    <div x-show="modals.addChunk" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70" 
         @click.self="modals.addChunk = false">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Add Content Chunk</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content Type</label>
                    <select x-model="newChunkData.contentType" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                        <option value="definition">Definition</option>
                        <option value="explanation">Explanation</option>
                        <option value="example">Example</option>
                        <option value="procedure">Procedure</option>
                        <option value="common_errors">Common Errors</option>
                        <option value="key_points">Key Points</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content</label>
                    <textarea x-model="newChunkData.contentText" rows="10"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
                              placeholder="Enter content..."></textarea>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button @click="modals.addChunk = false" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    Cancel
                </button>
                <button @click="saveNewChunk()" 
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Course Modal (Create/Edit) -->
    <div x-show="modals.course" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70" 
         @click.self="modals.course = false">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100" x-text="courseData.id ? 'Edit Course' : 'New Course'"></h3>
            </div>
            
            <!-- Show form if not showing AI preview -->
            <div x-show="!aiCoursePreview" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title</label>
                    <input type="text" x-model="courseData.title" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Subject</label>
                    <input type="text" x-model="courseData.subject" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                    <textarea x-model="courseData.description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Difficulty Level</label>
                    <select x-model="courseData.difficulty_level"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
            </div>
            
            <!-- AI Preview -->
            <div x-show="aiCoursePreview" class="p-6 space-y-4">
                <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        ✨ Review the AI-generated course structure below. You can edit or delete lessons before saving.
                    </p>
                </div>
                
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    <template x-if="aiCoursePreview">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" x-text="aiCoursePreview.suggestion?.course_overview"></p>
                            
                            <template x-for="(lesson, lessonIdx) in aiCoursePreview.suggestion?.lessons || []" :key="lessonIdx">
                                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-900">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h4 class="font-semibold text-gray-900 dark:text-gray-100" x-text="lesson.title"></h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-400" x-text="lesson.description"></p>
                                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                                <span x-text="`${lesson.estimated_duration_minutes} minutes`"></span>
                                            </p>
                                        </div>
                                        <button @click="removeLessonFromPreview(lessonIdx)" 
                                                class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="mt-3 space-y-1">
                                        <p class="text-xs font-medium text-gray-700 dark:text-gray-300">Learning Outcomes:</p>
                                        <template x-for="outcome in lesson.learning_outcomes" :key="outcome.key">
                                            <div class="text-xs text-gray-600 dark:text-gray-400 pl-4">
                                                • <span x-text="outcome.description"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Loading State -->
            <div x-show="aiCourseGenerating" class="p-12 flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 dark:border-purple-400"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Generating course structure with lessons...</p>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-500">This may take 3-5 seconds</p>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-between">
                <!-- Left side buttons -->
                <div>
                    <button x-show="!courseData.id && !aiCoursePreview && !aiCourseGenerating" 
                            @click="generateCourseStructure()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        ✨ AI: Generate Course Structure
                    </button>
                    <button x-show="aiCoursePreview" 
                            @click="aiCoursePreview = null" 
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        ← Back to Edit
                    </button>
                </div>
                
                <!-- Right side buttons -->
                <div class="flex gap-3">
                    <button @click="modals.course = false; aiCoursePreview = null" 
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        Cancel
                    </button>
                    <button x-show="!aiCoursePreview" 
                            @click="saveCourse()" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Save Course
                    </button>
                    <button x-show="aiCoursePreview" 
                            @click="saveAICourseStructure()" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Create Course with Lessons
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lesson Modal (Create/Edit) -->
    <div x-show="modals.lesson" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70" 
         @click.self="modals.lesson = false">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100" x-text="lessonData.id ? 'Edit Lesson' : 'New Lesson'"></h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title</label>
                    <input type="text" x-model="lessonData.title" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Topic</label>
                    <input type="text" x-model="lessonData.topic" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                    <textarea x-model="lessonData.description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Duration (minutes)</label>
                        <input type="number" x-model="lessonData.estimated_duration_minutes" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mastery Threshold</label>
                        <input type="number" step="0.1" min="0" max="1" x-model="lessonData.mastery_threshold" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button @click="modals.lesson = false" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    Cancel
                </button>
                <button @click="saveLesson()" 
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- AI Lesson Suggestion Modal -->
    <div x-show="modals.lessonAI" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70" 
         @click.self="modals.lessonAI = false">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">✨ AI Lesson Structure Suggestion</h3>
            </div>
            <div class="p-6 space-y-4">
                <div x-show="!aiSuggestion">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lesson Title</label>
                            <input type="text" x-model="aiLessonData.title" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Topic</label>
                            <input type="text" x-model="aiLessonData.topic" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description (optional)</label>
                            <textarea x-model="aiLessonData.description" rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>
                </div>
                <div x-show="aiSuggestion" class="space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 dark:text-blue-200 mb-2">Overview</h4>
                        <p class="text-sm text-blue-800 dark:text-blue-300" x-text="aiSuggestion?.suggestion?.lesson_overview"></p>
                        <p class="text-sm text-blue-600 dark:text-blue-400 mt-2">
                            Estimated Duration: <span x-text="aiSuggestion?.suggestion?.estimated_duration_minutes"></span> minutes
                        </p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">Suggested Learning Outcomes</h4>
                        <div class="space-y-3">
                            <template x-for="(outcome, idx) in aiSuggestion?.suggestion?.learning_outcomes" :key="idx">
                                <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
                                    <div class="space-y-2">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Key</label>
                                            <input type="text" x-model="outcome.key" 
                                                   class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Description</label>
                                            <textarea x-model="outcome.description" rows="2"
                                                      class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Key Concepts</label>
                                            <textarea x-model="outcome.key_concepts" rows="2"
                                                      class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Examples</label>
                                            <textarea x-model="outcome.examples" rows="2"
                                                      class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button @click="modals.lessonAI = false" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    Cancel
                </button>
                <button @click="generateLessonSuggestion()" x-show="!aiSuggestion"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    ✨ Generate Suggestion
                </button>
                <button @click="createLessonFromAI()" x-show="aiSuggestion"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    Create Lesson
                </button>
            </div>
        </div>
    </div>

    <!-- Learning Outcome Modal (Create/Edit) -->
    <div x-show="modals.outcome" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70" 
         @click.self="modals.outcome = false">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100" x-text="outcomeData.id ? 'Edit Learning Outcome' : 'New Learning Outcome'"></h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Key</label>
                    <input type="text" x-model="outcomeData.key" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
                           placeholder="e.g., understand_classes">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                    <textarea x-model="outcomeData.description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Key Concepts (optional)</label>
                    <textarea x-model="outcomeData.key_concepts" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Examples (optional)</label>
                    <textarea x-model="outcomeData.examples" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button @click="modals.outcome = false" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    Cancel
                </button>
                <button @click="saveOutcome()" 
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Content Generation Progress Modal -->
    <div x-show="bulkGenerating" 
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-70">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Generating Course Content</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <span>Progress</span>
                        <span x-text="`${bulkProgress.completed}/${bulkProgress.total} learning outcomes`"></span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div class="bg-amber-600 h-3 rounded-full transition-all duration-300" 
                             :style="`width: ${(bulkProgress.completed / bulkProgress.total) * 100}%`"></div>
                    </div>
                </div>
                
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    <template x-for="item in bulkProgress.items" :key="item.key">
                        <div class="flex items-center gap-2 text-sm">
                            <template x-if="item.status === 'pending'">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                </svg>
                            </template>
                            <template x-if="item.status === 'generating'">
                                <svg class="w-4 h-4 text-amber-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </template>
                            <template x-if="item.status === 'success'">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </template>
                            <template x-if="item.status === 'error'">
                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </template>
                            <span class="text-gray-700 dark:text-gray-300" x-text="item.description"></span>
                        </div>
                    </template>
                </div>
                
                <div x-show="bulkProgress.failed > 0" class="mt-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                    <p class="text-sm text-red-800 dark:text-red-200">
                        <span x-text="bulkProgress.failed"></span> outcome(s) failed to generate. You can retry these individually later.
                    </p>
                </div>
                
                <div x-show="bulkProgress.completed === bulkProgress.total && bulkProgress.failed === 0" 
                     class="mt-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                    <p class="text-sm text-green-800 dark:text-green-200">
                        ✓ All content generated successfully! The course is now ready for assessments.
                    </p>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button x-show="bulkProgress.completed === bulkProgress.total" 
                        @click="closeBulkGeneration()" 
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function contentManager() {
    return {
        loading: true,
        courses: [],
        filteredCourses: [],
        searchTerm: '',
        modals: {
            upload: false,
            generate: false,
            edit: false,
            course: false,
            lesson: false,
            lessonAI: false,
            outcome: false,
            addChunk: false
        },
        uploadMethod: 'text',
        uploadData: {
            outcomeId: null,
            contentType: 'explanation',
            contentText: '',
            pdfFile: null
        },
        selectedOutcome: null,
        generatedContent: null,
        editData: {
            contentId: null,
            outcomeId: null,
            contentText: '',
            approvalStatus: 'approved'
        },
        newChunkData: {
            outcomeId: null,
            contentType: 'explanation',
            contentText: ''
        },
        courseData: {
            id: null,
            title: '',
            subject: '',
            description: '',
            difficulty_level: 'beginner'
        },
        lessonData: {
            id: null,
            course_id: null,
            title: '',
            topic: '',
            description: '',
            estimated_duration_minutes: 60,
            mastery_threshold: 0.8
        },
        outcomeData: {
            id: null,
            lesson_id: null,
            key: '',
            description: '',
            key_concepts: '',
            examples: ''
        },
        aiLessonData: {
            course_id: null,
            title: '',
            topic: '',
            description: ''
        },
        aiSuggestion: null,
        aiCoursePreview: null,
        aiCourseGenerating: false,
        bulkGenerating: false,
        bulkProgress: {
            total: 0,
            completed: 0,
            failed: 0,
            items: []
        },

        async init() {
            await this.loadData();
        },

        async loadData() {
            try {
                const response = await fetch('/api/content-management/all');
                const data = await response.json();
                console.log('Loaded data:', data); // DEBUG
                this.courses = data.courses.map(course => ({
                    ...course,
                    expanded: false,
                    lessons: course.lessons.map(lesson => ({
                        ...lesson,
                        expanded: false,
                        learning_outcomes: lesson.learning_outcomes.map(outcome => ({
                            ...outcome,
                            content_chunks: outcome.content_chunks || []
                        }))
                    }))
                }));
                this.filteredCourses = this.courses;
                this.loading = false;
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load content');
            }
        },

        toggleCourse(idx) {
            this.filteredCourses[idx].expanded = !this.filteredCourses[idx].expanded;
        },

        toggleLesson(courseIdx, lessonIdx) {
            this.filteredCourses[courseIdx].lessons[lessonIdx].expanded = 
                !this.filteredCourses[courseIdx].lessons[lessonIdx].expanded;
        },

        expandAll() {
            this.filteredCourses.forEach((course, idx) => {
                this.filteredCourses[idx].expanded = true;
                course.lessons.forEach((lesson, lidx) => {
                    this.filteredCourses[idx].lessons[lidx].expanded = true;
                });
            });
        },

        collapseAll() {
            this.filteredCourses.forEach((course, idx) => {
                this.filteredCourses[idx].expanded = false;
                course.lessons.forEach((lesson, lidx) => {
                    this.filteredCourses[idx].lessons[lidx].expanded = false;
                });
            });
        },

        filterContent() {
            if (!this.searchTerm) {
                this.filteredCourses = this.courses;
                return;
            }
            const term = this.searchTerm.toLowerCase();
            // Create NEW objects with the SAME nested object references
            this.filteredCourses = this.courses.filter(course => 
                course.title.toLowerCase().includes(term) ||
                course.lessons.some(lesson => 
                    lesson.title.toLowerCase().includes(term) ||
                    lesson.learning_outcomes.some(outcome => 
                        outcome.key.toLowerCase().includes(term) ||
                        outcome.description.toLowerCase().includes(term)
                    )
                )
            );
        },

        openUploadModal(outcome) {
            this.selectedOutcome = outcome;
            this.uploadData.outcomeId = outcome.id;
            this.uploadData.contentText = '';
            this.modals.upload = true;
        },

        handlePdfSelect(event) {
            this.uploadData.pdfFile = event.target.files[0];
        },

        async submitUpload() {
            if (this.uploadMethod === 'text') {
                const formData = new FormData();
                formData.append('content_text', this.uploadData.contentText);
                formData.append('content_type', this.uploadData.contentType);

                try {
                    const response = await fetch(`/api/outcomes/${this.uploadData.outcomeId}/content`, {
                        method: 'POST',
                        body: formData
                    });
                    if (response.ok) {
                        this.modals.upload = false;
                        await this.loadData();
                        alert('Content uploaded successfully!');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Upload failed');
                }
            }
        },

        openGenerateModal(outcome) {
            this.selectedOutcome = outcome;
            this.generatedContent = null;
            this.modals.generate = true;
        },

        async generateContent() {
            try {
                const response = await fetch(`/api/outcomes/${this.selectedOutcome.id}/generate-content`, {
                    method: 'POST'
                });
                const data = await response.json();
                this.generatedContent = JSON.stringify(data.generated_content, null, 2);
            } catch (error) {
                console.error('Error:', error);
                alert('Generation failed');
            }
        },

        async saveGenerated() {
            try {
                const response = await fetch(`/api/outcomes/${this.selectedOutcome.id}/save-generated-content`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: this.generatedContent
                });
                if (response.ok) {
                    this.modals.generate = false;
                    await this.loadData();
                    alert('Content saved!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Save failed');
            }
        },

        // Add Content Chunk
        openAddChunkModal(outcome) {
            this.newChunkData = {
                outcomeId: outcome.id,
                contentType: 'explanation',
                contentText: ''
            };
            this.modals.addChunk = true;
        },

        async saveNewChunk() {
            if (!this.newChunkData.contentText) {
                alert('Please enter content');
                return;
            }

            const formData = new FormData();
            formData.append('outcome_id', this.newChunkData.outcomeId);
            formData.append('content_type', this.newChunkData.contentType);
            formData.append('content_text', this.newChunkData.contentText);

            try {
                const response = await fetch('/api/content', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    this.modals.addChunk = false;
                    await this.loadData();
                    alert('Content chunk added!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Save failed');
            }
        },

        async deleteContentChunk(contentId) {
            if (!confirm('Delete this content chunk?')) return;
            try {
                const response = await fetch(`/api/content/${contentId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await this.loadData();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Delete failed');
            }
        },

        async moveChunkUp(outcomeId, chunkIdx) {
            await this.swapChunks(outcomeId, chunkIdx, chunkIdx - 1);
        },

        async moveChunkDown(outcomeId, chunkIdx) {
            await this.swapChunks(outcomeId, chunkIdx, chunkIdx + 1);
        },

        async swapChunks(outcomeId, idx1, idx2) {
            const outcome = this.findOutcomeById(outcomeId);
            if (!outcome) return;

            const chunks = outcome.content_chunks;
            const chunk1 = chunks[idx1];
            const chunk2 = chunks[idx2];

            try {
                // Update chunk orders on backend
                await fetch(`/api/content/${chunk1.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content_text: chunk1.content_text,
                        chunk_order: idx2,
                        approval_status: chunk1.approval_status
                    })
                });

                await fetch(`/api/content/${chunk2.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content_text: chunk2.content_text,
                        chunk_order: idx1,
                        approval_status: chunk2.approval_status
                    })
                });

                await this.loadData();
            } catch (error) {
                console.error('Error:', error);
                alert('Reorder failed');
            }
        },

        findOutcomeById(outcomeId) {
            for (const course of this.courses) {
                for (const lesson of course.lessons) {
                    const outcome = lesson.learning_outcomes.find(o => o.id === outcomeId);
                    if (outcome) return outcome;
                }
            }
            return null;
        },

        openEditModal(chunk, outcomeId) {
            this.editData = {
                contentId: chunk.id,
                outcomeId: outcomeId,
                contentText: chunk.content_text,
                approvalStatus: chunk.approval_status
            };
            this.modals.edit = true;
        },

        async saveEdit() {
            try {
                const response = await fetch(`/api/content/${this.editData.contentId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        content_text: this.editData.contentText,
                        approval_status: this.editData.approvalStatus
                    })
                });
                if (response.ok) {
                    this.modals.edit = false;
                    await this.loadData();
                    alert('Content updated!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Update failed');
            }
        },

        async deleteContent() {
            if (!confirm('Delete this content?')) return;
            try {
                const response = await fetch(`/api/content/${this.editData.contentId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    this.modals.edit = false;
                    await this.loadData();
                    alert('Content deleted!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Delete failed');
            }
        },

        // Course CRUD
        openCourseModal() {
            this.courseData = {
                id: null,
                title: '',
                subject: '',
                description: '',
                difficulty_level: 'beginner'
            };
            this.aiCoursePreview = null;
            this.aiCourseGenerating = false;
            this.modals.course = true;
        },

        openEditCourseModal(course) {
            this.courseData = {
                id: course.id,
                title: course.title,
                subject: course.subject,
                description: course.description || '',
                difficulty_level: course.difficulty_level || 'beginner'
            };
            this.modals.course = true;
        },

        async saveCourse() {
            const formData = new FormData();
            formData.append('title', this.courseData.title);
            formData.append('subject', this.courseData.subject);
            formData.append('description', this.courseData.description);
            formData.append('difficulty_level', this.courseData.difficulty_level);

            try {
                const url = this.courseData.id 
                    ? `/api/courses/${this.courseData.id}`
                    : '/api/courses';
                const method = this.courseData.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                if (response.ok) {
                    this.modals.course = false;
                    await this.loadData();
                    alert(this.courseData.id ? 'Course updated!' : 'Course created!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Save failed');
            }
        },

        async deleteCourse(courseId) {
            if (!confirm('Delete this course? This will also delete all lessons and outcomes.')) return;
            try {
                const response = await fetch(`/api/courses/${courseId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await this.loadData();
                    alert('Course deleted!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Delete failed');
            }
        },

        async generateCourseStructure() {
            if (!this.courseData.title || !this.courseData.subject) {
                alert('Please enter course title and subject first');
                return;
            }

            this.aiCourseGenerating = true;

            try {
                const response = await fetch('/api/courses/suggest-structure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.courseData.title,
                        subject: this.courseData.subject,
                        description: this.courseData.description,
                        difficulty_level: this.courseData.difficulty_level
                    })
                });

                if (response.ok) {
                    this.aiCoursePreview = await response.json();
                    this.aiCourseGenerating = false;
                } else {
                    throw new Error('Failed to generate course structure');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate course structure. Please try again.');
                this.aiCourseGenerating = false;
            }
        },

        removeLessonFromPreview(lessonIdx) {
            this.aiCoursePreview.suggestion.lessons.splice(lessonIdx, 1);
        },

        async saveAICourseStructure() {
            if (!this.aiCoursePreview) return;

            try {
                const response = await fetch('/api/courses/create-from-suggestion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.courseData.title,
                        subject: this.courseData.subject,
                        description: this.courseData.description || this.aiCoursePreview.suggestion.course_overview,
                        difficulty_level: this.courseData.difficulty_level,
                        lessons: this.aiCoursePreview.suggestion.lessons
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    this.modals.course = false;
                    this.aiCoursePreview = null;
                    await this.loadData();
                    alert(`Course created with ${result.lessons.length} lessons!`);
                } else {
                    throw new Error('Failed to create course');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to save course. Please try again.');
            }
        },

        // Lesson CRUD
        openLessonModal(course) {
            this.lessonData = {
                id: null,
                course_id: course.id,
                title: '',
                topic: '',
                description: '',
                estimated_duration_minutes: 60,
                mastery_threshold: 0.8
            };
            this.modals.lesson = true;
        },

        openEditLessonModal(lesson) {
            this.lessonData = {
                id: lesson.id,
                course_id: lesson.course_id,
                title: lesson.title,
                topic: lesson.topic,
                description: lesson.description || '',
                estimated_duration_minutes: lesson.estimated_duration_minutes || 60,
                mastery_threshold: lesson.mastery_threshold || 0.8
            };
            this.modals.lesson = true;
        },

        async saveLesson() {
            const formData = new FormData();
            formData.append('title', this.lessonData.title);
            formData.append('topic', this.lessonData.topic);
            formData.append('description', this.lessonData.description);
            formData.append('estimated_duration_minutes', this.lessonData.estimated_duration_minutes);
            formData.append('mastery_threshold', this.lessonData.mastery_threshold);

            try {
                const url = this.lessonData.id 
                    ? `/api/lessons/${this.lessonData.id}`
                    : `/api/courses/${this.lessonData.course_id}/lessons`;
                const method = this.lessonData.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                if (response.ok) {
                    this.modals.lesson = false;
                    await this.loadData();
                    alert(this.lessonData.id ? 'Lesson updated!' : 'Lesson created!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Save failed');
            }
        },

        async deleteLesson(lessonId) {
            if (!confirm('Delete this lesson? This will also delete all learning outcomes.')) return;
            try {
                const response = await fetch(`/api/lessons/${lessonId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await this.loadData();
                    alert('Lesson deleted!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Delete failed');
            }
        },

        // AI Lesson Suggestion
        openLessonAIModal(course) {
            this.aiLessonData = {
                course_id: course.id,
                title: '',
                topic: '',
                description: ''
            };
            this.aiSuggestion = null;
            this.modals.lessonAI = true;
        },

        async generateLessonSuggestion() {
            try {
                const response = await fetch('/api/lessons/suggest-structure', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        lesson_title: this.aiLessonData.title,
                        lesson_topic: this.aiLessonData.topic,
                        lesson_description: this.aiLessonData.description,
                        course_id: this.aiLessonData.course_id
                    })
                });
                
                if (response.ok) {
                    this.aiSuggestion = await response.json();
                } else {
                    alert('Failed to generate suggestion');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Generation failed');
            }
        },

        async createLessonFromAI() {
            try {
                const response = await fetch('/api/lessons/create-from-suggestion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        course_id: this.aiLessonData.course_id,
                        lesson_title: this.aiLessonData.title,
                        lesson_topic: this.aiLessonData.topic,
                        lesson_description: this.aiLessonData.description,
                        lesson_overview: this.aiSuggestion.suggestion.lesson_overview,
                        estimated_duration_minutes: this.aiSuggestion.suggestion.estimated_duration_minutes,
                        learning_outcomes: this.aiSuggestion.suggestion.learning_outcomes
                    })
                });
                
                if (response.ok) {
                    this.modals.lessonAI = false;
                    await this.loadData();
                    alert('Lesson created with learning outcomes!');
                } else {
                    alert('Failed to create lesson');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Creation failed');
            }
        },

        // Learning Outcome CRUD
        openOutcomeModal(lesson) {
            this.outcomeData = {
                id: null,
                lesson_id: lesson.id,
                key: '',
                description: '',
                key_concepts: '',
                examples: ''
            };
            this.modals.outcome = true;
        },

        openEditOutcomeModal(outcome) {
            this.outcomeData = {
                id: outcome.id,
                lesson_id: outcome.lesson_id,
                key: outcome.key,
                description: outcome.description,
                key_concepts: outcome.key_concepts || '',
                examples: outcome.examples || ''
            };
            this.modals.outcome = true;
        },

        async saveOutcome() {
            const formData = new FormData();
            formData.append('key', this.outcomeData.key);
            formData.append('description', this.outcomeData.description);
            formData.append('key_concepts', this.outcomeData.key_concepts);
            formData.append('examples', this.outcomeData.examples);

            try {
                const url = this.outcomeData.id 
                    ? `/api/outcomes/${this.outcomeData.id}`
                    : `/api/lessons/${this.outcomeData.lesson_id}/outcomes`;
                const method = this.outcomeData.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                if (response.ok) {
                    this.modals.outcome = false;
                    await this.loadData();
                    alert(this.outcomeData.id ? 'Learning outcome updated!' : 'Learning outcome created!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Save failed');
            }
        },

        async deleteOutcome(outcomeId) {
            if (!confirm('Delete this learning outcome? This will also delete all content.')) return;
            try {
                const response = await fetch(`/api/outcomes/${outcomeId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await this.loadData();
                    alert('Learning outcome deleted!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Delete failed');
            }
        },

        // Bulk Content Generation
        async generateAllCourseContent(course) {
            // Collect all learning outcomes from all lessons
            const allOutcomes = [];
            course.lessons.forEach(lesson => {
                lesson.learning_outcomes.forEach(outcome => {
                    allOutcomes.push({
                        id: outcome.id,
                        key: outcome.key,
                        description: outcome.description,
                        lesson_title: lesson.title
                    });
                });
            });

            if (allOutcomes.length === 0) {
                alert('No learning outcomes found in this course. Please add lessons and outcomes first.');
                return;
            }

            const confirm_msg = `Generate AI content for all ${allOutcomes.length} learning outcomes in this course? This will take approximately ${Math.ceil(allOutcomes.length * 3 / 60)} minutes.`;
            if (!confirm(confirm_msg)) return;

            // Initialize progress
            this.bulkProgress = {
                total: allOutcomes.length,
                completed: 0,
                failed: 0,
                items: allOutcomes.map(o => ({
                    id: o.id,
                    key: o.key,
                    description: `${o.lesson_title}: ${o.description}`,
                    status: 'pending'
                }))
            };
            this.bulkGenerating = true;

            // Generate content for each outcome sequentially
            for (let i = 0; i < allOutcomes.length; i++) {
                const outcome = allOutcomes[i];
                this.bulkProgress.items[i].status = 'generating';

                try {
                    const response = await fetch(`/api/outcomes/${outcome.id}/generate-and-save-content`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        this.bulkProgress.items[i].status = 'success';
                    } else {
                        this.bulkProgress.items[i].status = 'error';
                        this.bulkProgress.failed++;
                    }
                } catch (error) {
                    console.error(`Error generating content for outcome ${outcome.id}:`, error);
                    this.bulkProgress.items[i].status = 'error';
                    this.bulkProgress.failed++;
                }

                this.bulkProgress.completed++;
            }

            // Reload data to show new content
            await this.loadData();
        },

        closeBulkGeneration() {
            this.bulkGenerating = false;
            this.bulkProgress = {
                total: 0,
                completed: 0,
                failed: 0,
                items: []
            };
        }
    };
}
</script>
{% endblock %}
