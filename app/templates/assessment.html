{% extends "base.html" %}

{% block title %}Assessment: {{ lesson.title }} - AIMS{% endblock %}

{% block content %}
<div class="container" x-data="assessmentApp()">
    <div class="breadcrumb">
        <a href="/dashboard">Dashboard</a> / <a href="/course/{{ lesson.course_id }}">Course</a> / Assessment
    </div>
    
    <div class="assessment-container">
        <!-- Left Sidebar: Progress -->
        <aside class="assessment-sidebar">
            <h3>Learning Outcomes</h3>
            <div class="outcomes-progress" id="outcomes-progress">
                {% for outcome in learning_outcomes %}
                <div class="outcome-item {% if progress %}{% for p in progress %}{% if p.learning_outcome_id == outcome.id %}{% if p.is_mastered %}mastered{% endif %}{% endif %}{% endfor %}{% endif %}" data-outcome-id="{{ outcome.id }}">
                    <div class="outcome-header">
                        <span class="outcome-number">{{ loop.index }}</span>
                        <span class="outcome-key">{{ outcome.key }}</span>
                    </div>
                    <p class="outcome-description">{{ outcome.description }}</p>
                    <div class="outcome-progress-bar">
                        {% set mastery = 0 %}
                        {% if progress %}
                            {% for p in progress %}
                                {% if p.learning_outcome_id == outcome.id %}
                                    {% set mastery = (p.mastery_level * 100) | int %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <div class="progress-fill" style="width: {{ mastery }}%"></div>
                    </div>
                    <span class="outcome-mastery">{{ mastery }}% Mastery</span>
                </div>
                {% endfor %}
            </div>
        </aside>
        
        <!-- Main Chat Interface -->
        <div class="assessment-main">
            <div class="lesson-header">
                <h1>{{ lesson.title }}</h1>
                <p>{{ lesson.topic }}</p>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    {% if session.status == "completed" %}
                    <div class="message system">
                        <div class="message-content">
                            ðŸŽ‰ <strong>Congratulations!</strong> You've completed this assessment and achieved mastery of all learning outcomes!
                        </div>
                    </div>
                    {% endif %}
                    
                    {% for msg in messages %}
                        <!-- AI Question -->
                        <div class="message ai">
                            <div class="message-avatar">ðŸ¤–</div>
                            <div class="message-content">
                                <div class="message-header">
                                    <strong>AIMS</strong>
                                    <span class="message-time">{{ msg.asked_at.strftime('%H:%M') }}</span>
                                </div>
                                <div class="message-text">{{ msg.question }}</div>
                                {% if msg.event_type == "rephrase" %}
                                <span class="message-badge">ðŸ”„ Rephrased</span>
                                {% elif msg.event_type == "re_teach" %}
                                <span class="message-badge">ðŸ“š Re-teaching</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- User Answer (if exists) -->
                        {% if msg.answer %}
                        <div class="message user">
                            <div class="message-content">
                                <div class="message-header">
                                    <strong>You</strong>
                                    <span class="message-time">{{ msg.answered_at.strftime('%H:%M') }}</span>
                                </div>
                                <div class="message-text">{{ msg.answer }}</div>
                            </div>
                            <div class="message-avatar">ðŸ‘¤</div>
                        </div>
                        
                        <!-- AI Feedback -->
                        {% if msg.feedback %}
                        <div class="message ai feedback">
                            <div class="message-avatar">âœ¨</div>
                            <div class="message-content">
                                <div class="message-text">{{ msg.feedback }}</div>
                                {% if msg.score %}
                                <div class="score-indicator">
                                    Score: {{ (msg.score * 100) | int }}%
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- HTMX target for new messages -->
                    <div id="newMessages"></div>
                </div>
            </div>
            
            <!-- Answer Input (only if not completed) -->
            {% if session.status != "completed" %}
            <div class="chat-input-container">
                <form 
                    hx-post="/assess/{{ session.session_id }}/answer"
                    hx-target="#newMessages"
                    hx-swap="beforeend"
                    hx-on::after-request="if(event.detail.successful) { this.reset(); scrollToBottom(); }"
                    class="chat-input-form"
                >
                    <textarea 
                        name="answer" 
                        placeholder="Type your answer here..." 
                        rows="3" 
                        required
                        x-ref="answerInput"
                        @keydown.ctrl.enter="$el.form.requestSubmit()"
                    ></textarea>
                    <button type="submit" class="btn btn-primary">
                        Send Answer
                    </button>
                </form>
                <p class="input-hint">ðŸ’¡ Tip: Press Ctrl+Enter to send</p>
            </div>
            {% else %}
            <div class="completion-message">
                <h2>ðŸŽ‰ Assessment Complete!</h2>
                <p>You've mastered all learning outcomes for this lesson.</p>
                <a href="/dashboard" class="btn btn-primary">Return to Dashboard</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function assessmentApp() {
    return {
        init() {
            this.scrollToBottom();
        },
        scrollToBottom() {
            const container = document.getElementById('chatMessages');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
    }
}

// Update progress bars dynamically
function updateProgress(responseText) {
    console.log('[Progress Update] Called with response:', responseText);
    try {
        const data = JSON.parse(responseText);
        console.log('[Progress Update] Parsed data:', data);
        data.progress.forEach(p => {
            console.log(`[Progress Update] Processing outcome ${p.outcome_id}: ${p.mastery_level}`);
            const outcomeItem = document.querySelector(`[data-outcome-id="${p.outcome_id}"]`);
            if (outcomeItem) {
                const progressBar = outcomeItem.querySelector('.progress-fill');
                const masteryText = outcomeItem.querySelector('.outcome-mastery');
                const mastery = Math.round(p.mastery_level * 100);
                
                console.log(`[Progress Update] Updating outcome ${p.outcome_id} to ${mastery}%`);
                
                if (progressBar) {
                    progressBar.style.width = `${mastery}%`;
                }
                if (masteryText) {
                    masteryText.textContent = `${mastery}% Mastery`;
                }
                
                // Add mastered class if applicable
                if (p.is_mastered) {
                    outcomeItem.classList.add('mastered');
                } else {
                    outcomeItem.classList.remove('mastered');
                }
            } else {
                console.log(`[Progress Update] Could not find outcome item for ID ${p.outcome_id}`);
            }
        });
    } catch (e) {
        console.error('[Progress Update] Failed to update progress:', e);
    }
}

// Trigger progress update after form submission
document.body.addEventListener('htmx:afterRequest', function(event) {
    // Check if this was the answer submission
    if (event.detail.pathInfo.requestPath.includes('/answer')) {
        console.log('[HTMX] Answer submitted, triggering progress update');
        // Fetch and update progress
        const sessionId = window.location.pathname.split('/').pop();
        fetch(`/api/progress/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                console.log('[Progress Fetch] Got progress data:', data);
                updateProgress(JSON.stringify(data));
            })
            .catch(err => console.error('[Progress Fetch] Error:', err));
    }
});

// Auto-scroll on new messages
document.body.addEventListener('htmx:afterSwap', function(event) {
    const container = document.getElementById('chatMessages');
    if (container) {
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }
});
</script>
{% endblock %}
