{% extends "base.html" %}

{% block title %}Assessment: {{ lesson.title }} - AIMS{% endblock %}

{% block content %}
<div class="container" x-data="assessmentApp()">
    <div class="breadcrumb">
        <a href="/dashboard">Dashboard</a> / <a href="/course/{{ lesson.course_id }}">Course</a> / Assessment
    </div>
    
    <div class="assessment-container">
        <!-- Left Sidebar: Progress -->
        <aside class="assessment-sidebar">
            <h3>Learning Outcomes</h3>
            <div class="outcomes-progress" id="outcomes-progress">
                {% for outcome in learning_outcomes %}
                <div class="outcome-item {% if progress %}{% for p in progress %}{% if p.learning_outcome_id == outcome.id %}{% if p.is_mastered %}mastered{% endif %}{% endif %}{% endfor %}{% endif %}" data-outcome-id="{{ outcome.id }}">
                    <div class="outcome-header">
                        <span class="outcome-number">{{ loop.index }}</span>
                        <span class="outcome-key">{{ outcome.key }}</span>
                    </div>
                    <p class="outcome-description">{{ outcome.description }}</p>
                    <div class="outcome-progress-bar">
                        {% set mastery = 0 %}
                        {% if progress %}
                            {% for p in progress %}
                                {% if p.learning_outcome_id == outcome.id %}
                                    {% set mastery = (p.mastery_level * 100) | int %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <div class="progress-fill" style="width: {{ mastery }}%"></div>
                    </div>
                    <span class="outcome-mastery">{{ mastery }}% Mastery</span>
                </div>
                {% endfor %}
            </div>
        </aside>
        
        <!-- Main Chat Interface -->
        <div class="assessment-main">
            <div class="lesson-header">
                <h1>{{ lesson.title }}</h1>
                <p>{{ lesson.topic }}</p>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    {% if session.status == "completed" %}
                    <div class="message system">
                        <div class="message-content">
                            üéâ <strong>Congratulations!</strong> You've completed this assessment and achieved mastery of all learning outcomes!
                        </div>
                    </div>
                    {% endif %}
                    
                    {% for msg in messages %}
                        <!-- AI Question -->
                        <div class="message ai">
                            <div class="message-avatar">ü§ñ</div>
                            <div class="message-content">
                                <div class="message-header">
                                    <strong>AIMS</strong>
                                    <span class="message-time">{{ msg.asked_at.strftime('%H:%M') }}</span>
                                </div>
                                <div class="message-text">{{ msg.question }}</div>
                                {% if msg.event_type == "rephrase" %}
                                <span class="message-badge">üîÑ Rephrased</span>
                                {% elif msg.event_type == "re_teach" %}
                                <span class="message-badge">üìö Re-teaching</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- User Answer (if exists) -->
                        {% if msg.answer %}
                        <div class="message user">
                            <div class="message-content">
                                <div class="message-header">
                                    <strong>You</strong>
                                    <span class="message-time">{{ msg.answered_at.strftime('%H:%M') }}</span>
                                </div>
                                <div class="message-text">{{ msg.answer }}</div>
                            </div>
                            <div class="message-avatar">üë§</div>
                        </div>
                        
                        <!-- AI Feedback -->
                        {% if msg.feedback %}
                        <div class="message ai feedback">
                            <div class="message-avatar">‚ú®</div>
                            <div class="message-content">
                                <div class="message-text">{{ msg.feedback }}</div>
                                {% if msg.score %}
                                <div class="score-indicator">
                                    Score: {{ (msg.score * 100) | int }}%
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- HTMX target for new messages -->
                    <div id="newMessages"></div>
                </div>
            </div>
            
            <!-- Answer Input (only if not completed) -->
            {% if session.status != "completed" %}
            <div class="chat-input-container" x-data="voiceRecorder()">
                <form 
                    hx-post="/assess/{{ session.session_id }}/answer"
                    hx-target="#newMessages"
                    hx-swap="beforeend"
                    hx-on::after-request="if(event.detail.successful) { this.reset(); clearTranscript(); scrollToBottom(); }"
                    class="chat-input-form"
                    x-ref="answerForm"
                >
                    <textarea 
                        name="answer" 
                        placeholder="Type your answer or use voice recording..." 
                        rows="3" 
                        required
                        x-ref="answerInput"
                        x-model="transcript"
                        @keydown.ctrl.enter="$el.form.requestSubmit()"
                    ></textarea>
                    
                    <div class="chat-input-actions">
                        <!-- Voice Recording Button -->
                        <button 
                            type="button" 
                            @click="toggleRecording()" 
                            :class="{'btn-recording': isRecording}"
                            :disabled="isTranscribing"
                            class="btn btn-voice"
                            title="Record voice answer">
                            <span x-show="!isRecording && !hasRecording">üé§ Record</span>
                            <span x-show="isRecording">‚èπÔ∏è Stop</span>
                            <span x-show="hasRecording && !isRecording">üîÑ Re-record</span>
                        </button>
                        
                        <!-- Transcribe Button (shows when recording exists) -->
                        <button 
                            type="button"
                            x-show="hasRecording && !isTranscribing"
                            @click="transcribeAudio()"
                            class="btn btn-secondary"
                            :disabled="isTranscribing">
                            üìù Transcribe
                        </button>
                        
                        <!-- Send Answer Button -->
                        <button 
                            type="submit" 
                            class="btn btn-primary"
                            :disabled="isTranscribing">
                            Send Answer
                        </button>
                    </div>
                </form>
                
                <!-- Recording Status -->
                <div x-show="isRecording" class="recording-status">
                    <span class="recording-dot"></span>
                    <span>Recording... <span x-text="recordingTime"></span>s</span>
                </div>
                
                <!-- Transcription Loading -->
                <div x-show="isTranscribing" class="transcription-loading">
                    <div class="loading-spinner"></div>
                    <span>Transcribing audio...</span>
                </div>
                
                <!-- Error Message -->
                <div x-show="errorMessage" class="error-message" x-text="errorMessage"></div>
                
                <p class="input-hint">üí° Tip: Press Ctrl+Enter to send | Use üé§ to record voice answers</p>
            </div>
            {% else %}
            <div class="completion-message">
                <h2>üéâ Assessment Complete!</h2>
                <p>You've mastered all learning outcomes for this lesson.</p>
                <a href="/dashboard" class="btn btn-primary">Return to Dashboard</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/assessment.js"></script>
<script src="/static/js/voice-recorder.js"></script>
{% endblock %}
