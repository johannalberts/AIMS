{% extends "base.html" %}

{% block title %}Learning Outcome Content - {{ outcome.key }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/course/{{ lesson.course_id }}">{{ course.title }}</a></li>
                    <li class="breadcrumb-item"><a href="#lesson-{{ lesson.id }}">{{ lesson.title }}</a></li>
                    <li class="breadcrumb-item active">{{ outcome.key }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <h2>Learning Outcome: {{ outcome.key }}</h2>
            <p class="lead">{{ outcome.description }}</p>
            <hr>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadContentModal">
                <i class="bi bi-upload"></i> Upload Content
            </button>
            <button class="btn btn-success" id="generateContentBtn">
                <i class="bi bi-magic"></i> Generate Content with AI
            </button>
        </div>
    </div>

    <!-- Content Chunks Display -->
    <div class="row">
        <div class="col">
            <h4>Learning Content</h4>
            <div id="contentChunksContainer">
                <!-- Content chunks will be loaded here -->
            </div>
            <div id="noContentMessage" class="alert alert-info" style="display: none;">
                No learning content available yet. Upload or generate content to get started.
            </div>
        </div>
    </div>
</div>

<!-- Upload Content Modal -->
<div class="modal fade" id="uploadContentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Learning Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadContentForm">
                    <div class="mb-3">
                        <label for="contentType" class="form-label">Content Type</label>
                        <select class="form-select" id="contentType" name="content_type" required>
                            <option value="definition">Definition</option>
                            <option value="explanation" selected>Explanation</option>
                            <option value="example">Example</option>
                            <option value="procedure">Procedure</option>
                            <option value="common_errors">Common Errors</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="contentText" class="form-label">Content</label>
                        <textarea class="form-control" id="contentText" name="content_text" rows="10" required 
                                  placeholder="Enter the learning content here..."></textarea>
                        <div class="form-text">Provide clear, comprehensive content that helps learners master this outcome.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveContentBtn">Save Content</button>
            </div>
        </div>
    </div>
</div>

<!-- Generated Content Modal -->
<div class="modal fade" id="generatedContentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI-Generated Learning Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="generatingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating content...</span>
                    </div>
                    <p class="mt-3">Generating content with AI... This may take a moment.</p>
                </div>
                <div id="generatedContentContainer" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Review the generated content below.</strong> You can edit any section before saving.
                    </div>
                    <div id="generatedChunksEditor">
                        <!-- Generated chunks will be loaded here for editing -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveGeneratedContentBtn" style="display: none;">
                    Approve & Save All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Content Modal -->
<div class="modal fade" id="editContentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Content Chunk</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editContentForm">
                    <input type="hidden" id="editContentId">
                    <div class="mb-3">
                        <label for="editContentType" class="form-label">Content Type</label>
                        <select class="form-select" id="editContentType" required>
                            <option value="definition">Definition</option>
                            <option value="explanation">Explanation</option>
                            <option value="example">Example</option>
                            <option value="procedure">Procedure</option>
                            <option value="common_errors">Common Errors</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editContentText" class="form-label">Content</label>
                        <textarea class="form-control" id="editContentText" rows="10" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateContentBtn">Update Content</button>
            </div>
        </div>
    </div>
</div>

<script>
const outcomeId = {{ outcome.id }};
let currentChunks = [];

// Load content chunks on page load
document.addEventListener('DOMContentLoaded', function() {
    loadContentChunks();
});

// Load content chunks
async function loadContentChunks() {
    try {
        const response = await fetch(`/api/outcomes/${outcomeId}/content`);
        const data = await response.json();
        
        currentChunks = data.content_chunks;
        displayContentChunks(currentChunks);
    } catch (error) {
        console.error('Error loading content chunks:', error);
        showError('Failed to load content chunks');
    }
}

// Display content chunks
function displayContentChunks(chunks) {
    const container = document.getElementById('contentChunksContainer');
    const noContentMsg = document.getElementById('noContentMessage');
    
    if (chunks.length === 0) {
        container.innerHTML = '';
        noContentMsg.style.display = 'block';
        return;
    }
    
    noContentMsg.style.display = 'none';
    
    const html = chunks.map((chunk, index) => `
        <div class="card mb-3" data-chunk-id="${chunk.id}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <span class="badge bg-primary">${chunk.content_type}</span>
                    <span class="badge bg-secondary">${chunk.source}</span>
                    ${chunk.approval_status !== 'approved' ? `<span class="badge bg-warning">${chunk.approval_status}</span>` : ''}
                </span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editChunk(${chunk.id})">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteChunk(${chunk.id})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="content-text" style="white-space: pre-wrap;">${escapeHtml(chunk.content_text)}</div>
                <small class="text-muted">Created: ${new Date(chunk.created_at).toLocaleString()}</small>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Upload content
document.getElementById('saveContentBtn').addEventListener('click', async function() {
    const form = document.getElementById('uploadContentForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch(`/api/outcomes/${outcomeId}/content`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            showSuccess('Content uploaded successfully');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadContentModal'));
            modal.hide();
            
            // Reset form
            form.reset();
            
            // Reload chunks
            loadContentChunks();
        } else {
            throw new Error('Failed to upload content');
        }
    } catch (error) {
        console.error('Error uploading content:', error);
        showError('Failed to upload content');
    }
});

// Generate content
document.getElementById('generateContentBtn').addEventListener('click', async function() {
    const modal = new bootstrap.Modal(document.getElementById('generatedContentModal'));
    modal.show();
    
    // Show spinner
    document.getElementById('generatingSpinner').style.display = 'block';
    document.getElementById('generatedContentContainer').style.display = 'none';
    document.getElementById('saveGeneratedContentBtn').style.display = 'none';
    
    try {
        const response = await fetch(`/api/outcomes/${outcomeId}/generate-content`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            displayGeneratedContent(data.chunks);
        } else {
            throw new Error('Failed to generate content');
        }
    } catch (error) {
        console.error('Error generating content:', error);
        showError('Failed to generate content');
        modal.hide();
    }
});

// Display generated content for review
function displayGeneratedContent(chunks) {
    document.getElementById('generatingSpinner').style.display = 'none';
    document.getElementById('generatedContentContainer').style.display = 'block';
    document.getElementById('saveGeneratedContentBtn').style.display = 'block';
    
    const container = document.getElementById('generatedChunksEditor');
    
    const html = chunks.map((chunk, index) => `
        <div class="card mb-3">
            <div class="card-header">
                <strong>${chunk.content_type.toUpperCase()}</strong>
            </div>
            <div class="card-body">
                <textarea class="form-control generated-chunk-text" rows="8" data-chunk-index="${index}">${escapeHtml(chunk.content_text)}</textarea>
                <input type="hidden" class="generated-chunk-type" value="${chunk.content_type}" data-chunk-index="${index}">
                <input type="hidden" class="generated-chunk-order" value="${chunk.chunk_order}" data-chunk-index="${index}">
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Save generated content
document.getElementById('saveGeneratedContentBtn').addEventListener('click', async function() {
    // Collect edited chunks
    const chunks = [];
    const textAreas = document.querySelectorAll('.generated-chunk-text');
    
    textAreas.forEach(textarea => {
        const index = textarea.dataset.chunkIndex;
        const typeInput = document.querySelector(`.generated-chunk-type[data-chunk-index="${index}"]`);
        const orderInput = document.querySelector(`.generated-chunk-order[data-chunk-index="${index}"]`);
        
        chunks.push({
            content_text: textarea.value,
            content_type: typeInput.value,
            chunk_order: parseInt(orderInput.value)
        });
    });
    
    try {
        const response = await fetch(`/api/outcomes/${outcomeId}/save-generated-content`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ chunks })
        });
        
        if (response.ok) {
            const data = await response.json();
            showSuccess(data.message);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('generatedContentModal'));
            modal.hide();
            
            // Reload chunks
            loadContentChunks();
        } else {
            throw new Error('Failed to save content');
        }
    } catch (error) {
        console.error('Error saving content:', error);
        showError('Failed to save content');
    }
});

// Edit chunk
function editChunk(chunkId) {
    const chunk = currentChunks.find(c => c.id === chunkId);
    if (!chunk) return;
    
    document.getElementById('editContentId').value = chunk.id;
    document.getElementById('editContentType').value = chunk.content_type;
    document.getElementById('editContentText').value = chunk.content_text;
    
    const modal = new bootstrap.Modal(document.getElementById('editContentModal'));
    modal.show();
}

// Update content
document.getElementById('updateContentBtn').addEventListener('click', async function() {
    const contentId = document.getElementById('editContentId').value;
    const contentType = document.getElementById('editContentType').value;
    const contentText = document.getElementById('editContentText').value;
    
    try {
        const response = await fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content_type: contentType,
                content_text: contentText
            })
        });
        
        if (response.ok) {
            showSuccess('Content updated successfully');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editContentModal'));
            modal.hide();
            
            // Reload chunks
            loadContentChunks();
        } else {
            throw new Error('Failed to update content');
        }
    } catch (error) {
        console.error('Error updating content:', error);
        showError('Failed to update content');
    }
});

// Delete chunk
async function deleteChunk(chunkId) {
    if (!confirm('Are you sure you want to delete this content chunk?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/content/${chunkId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccess('Content deleted successfully');
            loadContentChunks();
        } else {
            throw new Error('Failed to delete content');
        }
    } catch (error) {
        console.error('Error deleting content:', error);
        showError('Failed to delete content');
    }
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showSuccess(message) {
    // Simple alert for now - could be replaced with toast notifications
    alert(message);
}

function showError(message) {
    alert('Error: ' + message);
}
</script>
{% endblock %}
